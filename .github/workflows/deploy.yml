# Nom du workflow (visible dans l'onglet Actions sur GitHub)
name: CI/CD for ERP App

# DÃ©clenche le workflow sur chaque push ou pull request vers la branche main
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Variables dâ€™environnement utilisÃ©es dans tout le workflow
env:
  DJANGO_SECRET_KEY: super-secret            # ClÃ© secrÃ¨te pour Django
  DEBUG: False                               # Mode debug dÃ©sactivÃ©
  ALLOWED_HOSTS: localhost,127.0.0.1         # HÃ´tes autorisÃ©s pour Django
  POSTGRES_DB: erp_db                        # Nom de la base de donnÃ©es
  POSTGRES_USER: erp_user                    # Nom d'utilisateur de la base
  POSTGRES_PASSWORD: erp_pass                # Mot de passe de la base

jobs:
  build-and-deploy:                          # Nom du job
    runs-on: ubuntu-latest                   # Le job s'exÃ©cute sur une machine Ubuntu

    # On lance un service PostgreSQL pour les tests Django
    services:
      postgres:
        image: postgres:14                   # Utilise lâ€™image officielle de PostgreSQL
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready"          # VÃ©rifie que la base est prÃªte
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    # 1. RÃ©cupÃ¨re le code du dÃ©pÃ´t
    - name: ğŸ§¾ Checkout repo
      uses: actions/checkout@v3

    # â”€â”€â”€â”€â”€â”€â”€ PARTIE BACKEND (Django) â”€â”€â”€â”€â”€â”€â”€
    # 2. Configure Python
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 3. Installe les dÃ©pendances Django
    - name: ğŸ Install dependencies
      working-directory: ./backend
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt

    # 4. ExÃ©cute les migrations et les tests Django
    - name: âš™ï¸ Run Django tests
      working-directory: ./backend
      run: |
        source venv/bin/activate
        python manage.py migrate
        python manage.py test

    # â”€â”€â”€â”€â”€â”€â”€ PARTIE FRONTEND (Next.js) â”€â”€â”€â”€â”€â”€â”€
    # 5. Configure Node.js
    - name: ğŸ§° Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    # 6. Installe les dÃ©pendances frontend
    - name: ğŸ“¦ Install frontend dependencies
      working-directory: ./frontend
      run: npm install

    # 7. Compile le frontend (build de production)
    - name: ğŸ› ï¸ Build frontend
      working-directory: ./frontend
      run: npm run build

    # â”€â”€â”€â”€â”€â”€â”€ PUSH VERS DOCKER HUB â”€â”€â”€â”€â”€â”€â”€
    # 8. Connexion Ã  Docker Hub avec les secrets
    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}   # DÃ©fini dans GitHub > Settings > Secrets
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 9. Build et push de lâ€™image Docker du backend
    - name: ğŸ³ Build and push backend Docker image
      working-directory: ./backend
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/erp-backend:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/erp-backend:latest

    # 10. Build et push de lâ€™image Docker du frontend
    - name: ğŸ³ Build and push frontend Docker image
      working-directory: ./frontend
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/erp-frontend:latest .
        docker push ${{ secrets.DOCKER_USERNAME }}/erp-frontend:latest
